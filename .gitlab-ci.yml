image: registry.coinninja.net/engineering/android-sdk:latest

variables:
  GRADLE_USER_HOME: $CI_PROJECT_DIR/.gradle
  GRADLE_OPTS: "-Dorg.gradle.daemon=true"

stages:
  - test
  - build
  - deploy

before_script:
  - chmod +x ./gradlew
  - ./gradlew --version
  - ./gradlew --status
  - export ANDROID_HOME=/sdk-tools/
  - export PATH=$PATH:/sdk-tools/platform-tools/
  - export APP_VERSION=`./sh/appversion_lookup.sh $HOCKEY_APP_API_TOKEN`
  - echo $APP_VERSION
  - echo "${__google_services_json}" | base64 -d > ./app/google-services.json

cache:
  key: ${CI_PROJECT_ID}
  paths:
    - .gradle/


.build_and_sign: &build_and_sign
  before_script:
    - export APP_VERSION=`./sh/appversion_lookup.sh $HOCKEY_APP_API_TOKEN`
    - echo $APP_VERSION
    - export DB_CI_RUNNER=true
    - export ANDROID_HOME=/sdk-tools/
    - export PATH=$PATH:/sdk-tools/platform-tools/
    - chmod +x ./gradlew
    - git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@git.coinninja.net/cn/coin-keeper-android-code-signing.git /tmp/secret
    - mv /tmp/secret/*.enc app/
    - echo "${__google_services_json}" | base64 -d > ./app/google-services.json
    - echo "${__key_encryption_key}" | base64 -d > /tmp/secret/key
    - echo "${__playstore_service_key}" | base64 -d > ./app/build/google_play.json
    - openssl enc -d -aes-256-cbc -kfile /tmp/secret/key -in app/keystore.properties.enc -out app/keystore.properties
    - openssl enc -d -aes-256-cbc -kfile /tmp/secret/key -in app/coinkeeper-release.jks.enc -out app/coinkeeper-release.jks
    - export PREVIOUS_DEPLOY_COMMIT=`sh/gitlab_deploys.sh -t "${API_TOKEN}"`

test:
  stage: test
  tags:
    - linux
  script:
    - ./gradlew lintProductionDebug testProductionDebugUnitTest assembleDebug --stacktrace
  artifacts:
    when: always
    expire_in: '1 week'
    paths:
      - ./app/build/outputs/apk/production/debug/*.apk
      - ./app/build/outputs/apk/staging/debug/*.apk

build:
  stage: build
  tags:
    - linux
  script:
    - ./gradlew build
  artifacts:
    when: always
    expire_in: '1 week'
    paths:
      - ./app/build/outputs/apk/production/release/*.apk
  <<: *build_and_sign

release-candidate:
  stage: deploy
  script:
    - ./gradlew publishApkProductionRelease
  #- ./gradlew publishProductionRelease # with listings
  environment:
    name: internal
  tags:
    - linux
  artifacts:
    name: "manualInstallableAPK-$CI_COMMIT_REF_NAME-$CI_COMMIT_SHA"
    when: always
    expire_in: '1 week'
    paths:
      - ./app/build/outputs/apk/production/release/*.apk
  <<: *build_and_sign
  when: manual
  only:
    - develop@cn/dropbit-android
    - /^[\d\.]+RC$/@cn/dropbit-android

production-debug:
  stage: deploy
  script:
    - ./gradlew uploadProductionDebugToHockeyApp
  only:
    - develop@cn/dropbit-android
    - /^[\d\.]+RC$/@cn/dropbit-android
  tags:
    - linux
  environment:
    name: internal
  artifacts:
    name: "manualInstallableAPK-$CI_COMMIT_REF_NAME-$CI_COMMIT_SHA"
    when: always
    expire_in: '1 week'
    paths:
      - ./app/build/outputs/apk/production/release/*.apk

staging-debug:
  stage: deploy
  script:
    - ./gradlew uploadStagingDebugToHockeyApp
  only:
    - develop@cn/dropbit-android
    - /^[\d\.]+RC$/@cn/dropbit-android
  tags:
    - linux
  environment:
    name: internal
  artifacts:
    name: "manualInstallableAPK-$CI_COMMIT_REF_NAME-$CI_COMMIT_SHA"
    when: always
    expire_in: '1 week'
    paths:
      - ./app/build/outputs/apk/production/debug/*.apk
